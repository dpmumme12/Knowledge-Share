{% extends 'layouts/base_knowledgebase.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href='{% static 'knowledgebase/knowledgebase.css' %}'>
{% endblock styles %}

{% block body %}

<div class="col-12 text-end">
    <a href="{% url 'knowledgebase:article_create' %}" class="btn btn-info me-3">Create article <i class="fa-solid fa-plus fa-xs"></i></a>
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#CreateFolderModal">
        Create Folder <i class="fa-solid fa-plus fa-xs"></i>
    </button>
</div>

<div class="pt-3">

    <div class="col-12">
        <div class="col-4 d-inline-block">
            <form method="get">
                {{SearchForm}}
            </form>
        </div>
       
        <div class="col-5 d-inline-block float-end">
            <div class="action-items float-end">
                <a id="actions-dropdown" class="form-select text-decoration-none action-items" data-bs-toggle="dropdown" >
                    (Actions)
                </a>
                <ul class="dropdown-menu dropdown-menu-end" style="min-width: 7rem;">
                    <li class="dropdown-item">
                        <button id="change-folder-action" 
                                type="button" 
                                class="btn btn-link text-decoration-none p-0 text-dark"
                                >
                                Change Folder
                        </button>
                    </li>
                    <li class="dropdown-item">
                        <button id="delete-items-action"
                                type="button" 
                                class="btn btn-link text-decoration-none p-0 text-dark"
                                >
                                <i class="fa-solid fa-trash-can fa-xs text-secondary d-inline-block"></i>
                                <p class="text-danger d-inline-block ps-1 m-0">Delete</p>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    

    <hr class="my-2">

    <div class="col-12" >
        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
            <ol class="breadcrumb">
            {% if current_folder %}
                {% if current_folder.parent_folder.parent_folder %}
                    ...<li class="breadcrumb-item"><a href="{% url 'knowledgebase:knowledgebase_id' current_folder.parent_folder.parent_folder.id %}">{{current_folder.parent_folder.parent_folder.name}}</a></li>
                {% elif current_folder.parent_folder%}
                    <li class="breadcrumb-item"><a href="{% url 'knowledgebase:knowledgebase' %}">Root</a></li>
                {% endif %}

                {% if current_folder.parent_folder %}
                    <li class="breadcrumb-item"><a href="{% url 'knowledgebase:knowledgebase_id' current_folder.parent_folder.id %}">{{current_folder.parent_folder.name}}</a></li>
                {% elif current_folder %}
                    <li class="breadcrumb-item"><a href="{% url 'knowledgebase:knowledgebase' %}">Root</a></li>
                {% endif %}
                <li class="breadcrumb-item active" aria-current="page">{{current_folder.name}}</li>
            {% endif %}
            </ol>
        </nav>
        
        <ul class="list-group list-group-flush">

            {% for item in folder_content %}
                <li class="list-group-item list-group-item-action folder-list-item">
                    <div class="col-12 g-0">
                        <div class="d-inline-block col-11">
                            <input class="form-check-input me-1 item-checkbox-class" type="checkbox" value="" aria-label="..." 
                                   data-item-id="{{item.id}}"
                                   data-item-type="{{item.object_type}}"> 
                            <div class="d-inline-block col-9 position-relative">
                                {% if item.object_type == 'folder' %}
                                    <a href="{% url 'knowledgebase:knowledgebase_id' item.id %}"
                                    class="stretched-link text-decoration-none text-dark">
                                    
                                        <i class="fa-regular fa-folder px-2"></i> {{item.name}}
                                    </a>
                                {% else %}    
                                    <a href="{% url 'knowledgebase:article_edit' item.id %}"
                                    class="stretched-link text-decoration-none text-dark">
                                        <i class="fa-regular fa-file px-2 "></i> {{item.name}}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-inline-block col-1 g-0 float-end">
                            <div class="float-end">
                                <a class="folder-ellipsis" style="color: gray;" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
                                    <div class="px-2"><i class="fa-solid fa-ellipsis-vertical"></i></div>
                                </a>
                                <ul class="dropdown-menu" style="min-width: 7rem;">
                                    <li class="dropdown-item">
                                        <button type="button"
                                                {% if item.object_type == 'folder' %}
                                                    class="btn btn-link text-decoration-none p-0 edit-folder-class"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#EditFolderModal"
                                                    data-item-name="{{item.name}}"
                                                {% else %}
                                                    class="btn btn-link text-decoration-none p-0 change-folder-class"
                                                {% endif %}
                                                data-item-id="{{item.id}}"
                                                data-item-type="{{item.object_type}}"
                                                >

                                            <i class="fa-solid fa-pen-to-square fa-xs text-secondary d-inline-block"></i>
                                            <p class="text-dark d-inline-block ps-1 m-0">Edit</p>
                                        </button>
                                    </li>
                                    <li class="dropdown-item">
                                        <button type="button" 
                                                class="btn btn-link text-decoration-none p-0 confirmation-popup-class" 
                                                {% if item.object_type == 'folder' %}
                                                    data-confirm-url="{% url 'knowledgebase:folder_delete' item.id %}"
                                                    data-confirm-text="Deleting folder will delete all of its content. Are you sure?"
                                                {% else %}
                                                    data-confirm-url="{% url 'knowledgebase:article_delete' item.id %}"
                                                    data-confirm-text="Are you sure you want to delete article?"
                                                {% endif %}>

                                            <i class="fa-solid fa-trash-can fa-xs text-secondary d-inline-block"></i>
                                            <p class="text-danger d-inline-block ps-1 m-0">Delete</p>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </li>
            {% empty %}
                No folders created yet...
            {% endfor %}

        </ul>
    </div>
</div>

{# Popups and include tags listed below #}

<div class="modal fade" id="ChangeFolderPopup" tabindex="-1" aria-labelledby="ChangeFolderPopupLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Folder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form action="{% url 'knowledgebase:bulk_folder_change' %}" method="post">
                {% csrf_token %}
                {% for field in BulkChangeFolderForm %}
                <div>
                  {{ field.label_tag}}
                  {{ field }}
                  <div style="color: red;">{{ field.errors }}</div>
                </div>
                {% endfor %}
                <div class="text-center">
                    <div class="pe-1 d-inline-block">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                    <div class="ps-1 d-inline-block">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </form>
        </div>
      </div>
    </div>
</div>

<form action="{% url 'knowledgebase:bulk_delete' %}" method="post" id="BulkDeleteForm"> {% csrf_token %} {{BulkDeleteForm}}</form>
<button id="BulkDeleteButton" class="confirmation-popup-class" data-confirm-text="Deleting folders will delete all of its content. Are you sure?"
        data-confirm-form="BulkDeleteForm" hidden></button>


{% include 'blocks/form_popup.html' with id='CreateFolderModal' title='Create new folder' form=CreateFolderForm%}
{% include 'blocks/form_popup.html' with id='EditFolderModal' title='Edit folder' form=EditFolderForm%}
{% include 'blocks/confirmation_popup.html' %}

{% endblock body %}

{% block scripts %}
    {{user_folders|json_script:"user_folders"}}
    {{current_folder.id|json_script:"folder_id"}}
    <script src="{% static 'knowledgebase/knowledgebase.js' %}"></script>
{% endblock scripts %}
